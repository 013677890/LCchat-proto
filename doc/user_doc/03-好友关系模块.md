# 模块三：好友关系（Friend）

---

## 5.1 搜索用户 [P0]

**接口描述**: 通过邮箱、昵称、用户ID搜索用户

**请求信息**:
```
GET /api/v1/user/search
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| keyword | string | ✅ | 搜索关键词(邮箱/昵称/UUID) |
| page | int | ❌ | 页码(默认1) |
| pageSize | int | ❌ | 每页数量(默认20) |

**请求示例**:
```
GET /api/v1/user/search?keyword=zhangsan&page=1&pageSize=20
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "uuid": "user-uuid-001",
        "nickname": "张三",
        "email": "zha***@example.com",
        "avatar": "https://cdn.chatserver.com/avatars/user-001.jpg",
        "signature": "个性签名",
        "isFriend": false
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 1,
      "totalPages": 1
    }
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

---

## 5.2 发送好友申请 [P0]

**接口描述**: 向目标用户发送好友请求

**请求信息**:
```
POST /api/v1/user/friend/apply
```

**请求头**:
```http
Authorization: Bearer <access_token>
Content-Type: application/json
```

**请求体**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| targetUuid | string | ✅ | 目标用户UUID |
| reason | string | ❌ | 申请理由(最多255字符) |
| source | string | ❌ | 来源(search/qrcode/group) |

**请求示例**:
```json
{
  "targetUuid": "user-uuid-002",
  "reason": "你好，我是张三",
  "source": "search"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "申请已发送",
  "data": {
    "applyId": 10001
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 11001 | 用户不存在 |
| 12001 | 已经是好友 |
| 12002 | 好友申请已发送 |
| 16001 | 对方已将你拉黑 |
| 16002 | 你已将对方拉黑 |

---

## 5.3 获取好友申请列表 [P0]

**接口描述**: 获取收到的好友申请列表

**请求信息**:
```
GET /api/v1/user/friend/apply-list
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | int | ❌ | 状态(0:待处理 1:已同意 2:已拒绝,不传查全部) |
| page | int | ❌ | 页码(默认1) |
| pageSize | int | ❌ | 每页数量(默认20) |

**请求示例**:
```
GET /api/v1/user/friend/apply-list?status=0&page=1&pageSize=20
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "applyId": 10001,
        "applicantUuid": "user-uuid-002",
        "applicantInfo": {
          "uuid": "user-uuid-002",
          "nickname": "李四",
          "avatar": "https://cdn.chatserver.com/avatars/user-002.jpg"
        },
        "reason": "你好，我是李四",
        "source": "search",
        "status": 0,
        "isRead": false,
        "createdAt": "2026-01-19T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 1,
      "totalPages": 1
    }
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

---

## 5.4 获取发出的申请列表 [P2]

**接口描述**: 获取自己发出的好友申请列表

**请求信息**:
```
GET /api/v1/user/friend/sent-apply-list
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**查询参数**: 同 5.3

**响应示例**: 同 5.3（applicant 变为 target）

---

## 5.5 处理好友申请 [P0]

**接口描述**: 同意或拒绝好友申请

**请求信息**:
```
PUT /api/v1/user/friend/apply/{applyId}
```

**请求头**:
```http
Authorization: Bearer <access_token>
Content-Type: application/json
```

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| applyId | int | ✅ | 申请ID |

**请求体**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| action | int | ✅ | 操作(1:同意 2:拒绝) |
| remark | string | ❌ | 备注名(同意时设置) |

**请求示例**:
```json
{
  "action": 1,
  "remark": "老李"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "已同意好友申请",
  "module": "user",
  "timestamp": 1736344200000
}
```

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 12005 | 申请不存在或已处理 |
| 12006 | 无权限处理该申请 |

---

## 5.6 获取未读申请数量 [P1]

**接口描述**: 获取未读好友申请数量（红点提示）

**请求信息**:
```
GET /api/v1/user/friend/unread-count
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "unreadCount": 3
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

---

## 5.7 标记申请已读 [P1]

**接口描述**: 标记好友申请为已读（清除红点）

**请求信息**:
```
PUT /api/v1/user/friend/mark-read
```

**请求头**:
```http
Authorization: Bearer <access_token>
Content-Type: application/json
```

**请求体**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| applyIds | array | ❌ | 申请ID列表(不传则标记全部) |

**请求示例**:
```json
{
  "applyIds": [10001, 10002]
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "已标记为已读",
  "module": "user",
  "timestamp": 1736344200000
}
```

---

## 5.8 获取好友列表 [P0]

**接口描述**: 获取所有好友及详细信息

**请求信息**:
```
GET /api/v1/user/friend/list
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| groupTag | string | ❌ | 按标签筛选 |
| page | int | ❌ | 页码(默认1) |
| pageSize | int | ❌ | 每页数量(默认100) |

**请求示例**:
```
GET /api/v1/user/friend/list?page=1&pageSize=100
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "items": [
      {
        "uuid": "user-uuid-002",
        "nickname": "李四",
        "avatar": "https://cdn.chatserver.com/avatars/user-002.jpg",
        "gender": 1,
        "signature": "Hello World",
        "remark": "老李",
        "groupTag": "同事",
        "source": "search",
        "createdAt": "2026-01-10T10:00:00Z"
      }
    ],
    "pagination": {
      "page": 1,
      "pageSize": 100,
      "total": 1,
      "totalPages": 1
    },
    "version": 1736344200000
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

**说明**: 
- `version` 字段为好友列表的最新版本号（Unix毫秒时间戳）
- 客户端应保存此版本号，用于后续增量同步（见 5.9 接口）
- 首次全量拉取后，后续应使用增量同步接口以节省流量

---

## 5.9 好友增量同步 [P0]

**接口描述**: 增量同步好友列表变更（用于优化大好友列表场景）

**应用场景**: 
- 用户拥有大量好友（如 2000+ 个）
- App 启动时无需全量拉取好友列表
- 只同步自上次同步后发生变化的数据（新增、修改、删除）
- 大幅减少流量消耗和数据库压力

**请求信息**:
```
GET /api/v1/user/friend/sync
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| version | long | ✅ | 本地最新版本号(Unix毫秒时间戳) |
| limit | int | ❌ | 每次最多返回条数(默认100,最大500) |

**请求示例**:
```
GET /api/v1/user/friend/sync?version=1736344200000&limit=100
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "changes": [
      {
        "uuid": "user-uuid-002",
        "nickname": "李四",
        "avatar": "https://cdn.chatserver.com/avatars/user-002.jpg",
        "gender": 1,
        "signature": "Hello World",
        "remark": "老李",
        "groupTag": "同事",
        "source": "search",
        "changeType": "add",
        "changedAt": "2026-01-19T10:05:00Z"
      },
      {
        "uuid": "user-uuid-003",
        "remark": "老王头",
        "changeType": "update",
        "changedAt": "2026-01-19T11:00:00Z"
      },
      {
        "uuid": "user-uuid-004",
        "changeType": "delete",
        "changedAt": "2026-01-19T12:00:00Z"
      }
    ],
    "hasMore": false,
    "latestVersion": 1736358000000
  },
  "module": "user",
  "timestamp": 1736358000000
}
```

**字段说明**:

| 字段 | 说明 |
|------|------|
| changeType | 变更类型: `add`(新增好友) / `update`(修改备注/标签) / `delete`(删除好友) |
| changedAt | 变更时间 |
| hasMore | 是否还有更多变更(true时客户端应使用 latestVersion 继续请求) |
| latestVersion | 最新版本号(客户端应保存此值,下次同步时使用) |

**使用流程**:

1. **首次启动**: 客户端没有本地数据，调用 `GET /list` 全量拉取好友列表，保存返回的最新 `version`
2. **后续启动**: 调用 `GET /sync?version={本地版本}` 增量同步
3. **处理变更**: 
   - `add`: 添加到本地列表
   - `update`: 更新本地对应好友信息
   - `delete`: 从本地列表移除
4. **更新版本**: 保存 `latestVersion` 供下次使用

**说明**: 
- 当客户端本地版本号过旧（如超过30天），服务端可返回特殊错误码提示全量同步
- 删除类型的变更只返回 `uuid` 和 `changeType`，无需其他字段

---

## 5.10 删除好友 [P0]

**接口描述**: 删除好友关系（单向删除）

**行为说明**: 
- **单向删除**: A 删除 B 后，A 的好友列表中不再显示 B
- B 的好友列表中仍保留 A，B 可以正常给 A 发送消息
- A 不会在好友列表看到 B，但可以在聊天会话中查看历史消息
- 如需彻底屏蔽，请使用拉黑功能

**请求信息**:
```
DELETE /api/v1/user/friend/{userUuid}
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userUuid | string | ✅ | 好友UUID |

**请求示例**:
```
DELETE /api/v1/user/friend/user-uuid-002
```

**响应示例**:
```json
{
  "code": 0,
  "message": "好友已删除",
  "module": "user",
  "timestamp": 1736344200000
}
```

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 12003 | 不存在该好友关系 |

---

## 5.11 设置好友备注 [P1]

**接口描述**: 给好友设置备注名

**请求信息**:
```
PUT /api/v1/user/friend/{userUuid}/remark
```

**请求头**:
```http
Authorization: Bearer <access_token>
Content-Type: application/json
```

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userUuid | string | ✅ | 好友UUID |

**请求体**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| remark | string | ✅ | 备注名(最多64字符,空字符串表示清除) |

**请求示例**:
```json
{
  "remark": "老李头"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "备注已更新",
  "module": "user",
  "timestamp": 1736344200000
}
```

**错误码**:
| 错误码 | 说明 |
|--------|------|
| 12003 | 不存在该好友关系 |

---

## 5.12 设置好友标签 [P2]

**接口描述**: 给好友设置分组标签

**请求信息**:
```
PUT /api/v1/user/friend/{userUuid}/tag
```

**请求头**:
```http
Authorization: Bearer <access_token>
Content-Type: application/json
```

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userUuid | string | ✅ | 好友UUID |

**请求体**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| groupTag | string | ✅ | 标签名(最多32字符,空字符串表示清除) |

**请求示例**:
```json
{
  "groupTag": "同事"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "标签已更新",
  "module": "user",
  "timestamp": 1736344200000
}
```

---

## 5.13 获取标签列表 [P2]

**接口描述**: 获取所有好友标签及好友数量

**请求信息**:
```
GET /api/v1/user/friend/tags
```

**请求头**:
```http
Authorization: Bearer <access_token>
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "tags": [
      {
        "tagName": "同事",
        "count": 10
      },
      {
        "tagName": "同学",
        "count": 15
      },
      {
        "tagName": "家人",
        "count": 5
      }
    ]
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

---

## 5.14 判断是否好友 [P1]

**接口描述**: 内部接口，判断两用户是否为好友关系

**请求信息**:
```
POST /api/v1/user/friend/check
```

**请求头**:
```http
Authorization: Bearer <access_token>
Content-Type: application/json
```

**请求体**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userUuid | string | ✅ | 用户UUID |
| peerUuid | string | ✅ | 对方UUID |

**请求示例**:
```json
{
  "userUuid": "user-uuid-001",
  "peerUuid": "user-uuid-002"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "isFriend": true
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

---

## 5.15 获取关系状态 [P1]

**接口描述**: 内部接口，获取两用户详细关系（好友/拉黑/无关系）

**请求信息**:
```
POST /api/v1/user/friend/relation
```

**请求头**:
```http
Authorization: Bearer <access_token>
Content-Type: application/json
```

**请求体**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| userUuid | string | ✅ | 用户UUID |
| peerUuid | string | ✅ | 对方UUID |

**请求示例**:
```json
{
  "userUuid": "user-uuid-001",
  "peerUuid": "user-uuid-002"
}
```

**响应示例**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "relation": "friend",
    "isFriend": true,
    "isBlacklist": false,
    "remark": "老李",
    "groupTag": "同事"
  },
  "module": "user",
  "timestamp": 1736344200000
}
```

**说明**: 
- relation: none(无关系) / friend(好友) / blacklist(已拉黑) / deleted(已删除)

---

> **文档版本**: v1.0.0  
> **最后更新**: 2026-01-19  
> **维护人**: 开发团队
