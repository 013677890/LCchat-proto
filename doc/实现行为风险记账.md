# 实现行为风险记账

更新时间：2026-02-06  
范围：Gateway + User（单测阶段发现）

## 记录规范
- `风险ID`：模块前缀 + 递增编号，例如 `AUTH-001`。
- `状态`：`Open` / `Accepted` / `Fixed`。
- `处置策略`：仅记账、不改代码，或安排修复。

## 风险清单

| 风险ID | 模块 | 现实现行为 | 预期行为 | 影响 | 严重级别 | 状态 |
| --- | --- | --- | --- | --- | --- | --- |
| AUTH-001 | Gateway Auth Service | `Logout` / `ResetPassword` 成功时返回 `nil response` | 成功时返回空响应对象（非 `nil`）或统一约定 `nil` 并显式文档化 | 调用方若误判为非空对象，存在空指针/契约不一致风险 | 中 | Open |
| BLACKLIST-001 | Gateway Blacklist Handler | `GetBlacklistList` 先 `ShouldBindQuery` 且参数有 `min=1` 校验，`page/pageSize` 缺失时直接参数错误，默认值回填分支不可达 | 缺省分页参数时自动回填 `page=1`、`pageSize=20` | 接口行为与“默认分页”设计不一致，调用方体验不稳定 | 中 | Open |
| FRIEND-001 | User Friend Service | `GetFriendApplyList` / `GetSentApplyList` 未传 `status` 时直接透传 `0`（待处理），不自动扩展为“全部状态” | 未传 `status` 时可选返回全部状态，或在文档中明确默认只看待处理 | 直连 gRPC 调用时容易与网关行为（缺省改为 `-1`）产生语义偏差 | 中 | Open |
| FRIEND-002 | Gateway Friend Handler | `GetFriendApplyList` / `GetSentApplyList` / `GetFriendList` 先 `ShouldBindQuery` 且 `page/pageSize` 有 `min=1`，缺失参数时默认值分支不可达 | 缺省分页参数时自动回填 `page=1`、`pageSize=20` | 调用方不传分页参数会直接报参错，和“默认分页”注释不一致 | 中 | Open |
| USER-001 | Gateway User Handler | `SearchUser` 查询参数绑定对键名大小写敏感，常见小写参数（如 `keyword/page/pageSize`）会触发参数错误 | 接受常见小写查询参数并按约定回填默认值 | 网关对外接口可用性受影响，前端/第三方调用易踩坑 | 中 | Open |
| USER-002 | Gateway User Service | `GetOtherProfile` 使用 `async.RunSafe` + channel 等待结果，若协程池未初始化，任务不执行导致等待阻塞 | 协程池未初始化时仍可安全降级返回（不阻塞） | 存在请求卡死风险（启动顺序/测试环境更容易触发） | 高 | Open |

## 风险详情

### AUTH-001
- 证据代码：
  - `apps/gateway/internal/service/auth_service.go:196`
  - `apps/gateway/internal/service/auth_service.go:226`
  - `apps/gateway/internal/dto/auth_dto.go:306`
  - `apps/gateway/internal/dto/auth_dto.go:314`
- 当前结论：
  - 本轮单测已按现实现行为断言（成功时 `response == nil`）。
  - Handler 层对外仍可正常返回成功响应，但 service 层契约可读性偏弱。
- 处置建议：
  - 二选一并固定到文档：
  - 方案 A：service 成功统一返回空对象（推荐）。
  - 方案 B：明确约定该类方法成功可返回 `nil`，并在接口注释中声明。

### BLACKLIST-001
- 证据代码：
  - `apps/gateway/internal/router/v1/blacklist_handle.go:115`
  - `apps/gateway/internal/router/v1/blacklist_handle.go:120`
  - `apps/gateway/internal/router/v1/blacklist_handle.go:123`
  - `apps/gateway/internal/dto/blacklist_dto.go:27`
  - `apps/gateway/internal/dto/blacklist_dto.go:28`
- 当前结论：
  - 当 `page/pageSize` 为空时，会先触发参数校验错误，默认值逻辑无法生效。
  - 本轮单测已按现实现行为断言（缺参返回 `CodeParamError`）。
- 处置建议：
  - 若产品希望“缺省即默认分页”，需调整绑定/校验顺序或 DTO 校验策略。

### FRIEND-001
- 证据代码：
  - `apps/user/internal/service/friend_service.go:201`
  - `apps/user/internal/service/friend_service.go:308`
  - `apps/gateway/internal/router/v1/friend_handle.go:89`
  - `apps/gateway/internal/router/v1/friend_handle.go:149`
- 当前结论：
  - User service 自身没有“缺省 status -> -1”的逻辑，未传时按 protobuf 默认值 `0` 查询待处理。
  - Gateway handler 会在缺省查询参数时将 `status` 置为 `-1`，两层语义存在潜在偏差。
- 处置建议：
  - 明确统一规范：默认查“待处理”或“全部状态”二选一，并在网关与 user service 同步实现。
  - 若保持现状，需在 gRPC 接口文档中明确 `status` 缺省语义为 `0`。

### FRIEND-002
- 证据代码：
  - `apps/gateway/internal/router/v1/friend_handle.go:76`
  - `apps/gateway/internal/router/v1/friend_handle.go:92`
  - `apps/gateway/internal/router/v1/friend_handle.go:136`
  - `apps/gateway/internal/router/v1/friend_handle.go:152`
  - `apps/gateway/internal/router/v1/friend_handle.go:291`
  - `apps/gateway/internal/router/v1/friend_handle.go:299`
  - `apps/gateway/internal/dto/friend_dto.go:44`
  - `apps/gateway/internal/dto/friend_dto.go:45`
  - `apps/gateway/internal/dto/friend_dto.go:77`
  - `apps/gateway/internal/dto/friend_dto.go:78`
  - `apps/gateway/internal/dto/friend_dto.go:129`
  - `apps/gateway/internal/dto/friend_dto.go:130`
- 当前结论：
  - 分页字段带 `min=1` 校验，缺省参数在 bind 阶段即报错，后续默认值回填逻辑无法触达。
  - 测试已按现实现行为断言：缺省分页参数会返回 `CodeParamError`。
- 处置建议：
  - 若要支持“缺省分页”，应改为先回填后校验，或放宽 DTO 校验并在 handler 内统一归一化参数。

### USER-001
- 证据代码：
  - `apps/gateway/internal/router/v1/user_handle.go:111`
  - `apps/gateway/internal/router/v1/user_handle.go:119`
  - `apps/gateway/internal/dto/friend_dto.go:11`
  - `apps/gateway/internal/dto/friend_dto.go:12`
  - `apps/gateway/internal/dto/friend_dto.go:13`
- 当前结论：
  - 单测中使用 `keyword/page/pageSize` 无法通过绑定校验，需使用 `Keyword/Page/PageSize` 才能命中成功分支。
  - 这意味着常见调用方式可能被判为 `CodeParamError`。
- 处置建议：
  - 为 `SearchUserRequest` 增加 `form` 标签并固定小写参数；或统一在网关层文档中声明必须使用的键名。

### USER-002
- 证据代码：
  - `apps/gateway/internal/service/user_service.go:95`
  - `apps/gateway/internal/service/user_service.go:101`
  - `apps/gateway/internal/service/user_service.go:107`
  - `pkg/async/pool.go:90`
  - `pkg/async/pool.go:142`
- 当前结论：
  - `GetOtherProfile` 依赖异步任务向 channel 回写结果；若 `async` 全局池未初始化，`RunSafe` 提交失败后不会执行任务，读取 channel 可能阻塞。
  - 在单测中需要显式初始化 `async` 才能稳定覆盖该路径。
- 处置建议：
  - 在 `GetOtherProfile` 中对 `RunSafe` 提交失败增加兜底执行（同步调用或快速失败）。
  - 或在服务启动阶段硬性保证 `async` 初始化完成并加入健康检查。

## 跟踪约定
- 新增风险时在表格追加，并补充“风险详情”。
- 风险修复后将状态改为 `Fixed`，并补充修复 PR 或提交信息。
